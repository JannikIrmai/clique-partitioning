#include <fstream>
#include <vector>
#include <sstream>
#include <iterator>
#include <functional>

#include <inequalities/inequality.hxx>
#include <inequalities/separator.hxx>

#pragma once


namespace CP {

// Coefficients of facet-defining inequalities of CP_4 
std::vector<std::vector<int>> coefficients_4 = {
    {1,1,1,-1,-1,-1,1},
    {1,-1,-1,1,1,-1,1},
    {-1,1,-1,1,-1,1,1},
    {-1,-1,1,-1,1,1,1}
};

// Coefficients of facet-defining inequalities of CP_5
std::vector<std::vector<int>> coefficients_5 = {
    {-1,-1,1,1,-1,1,1,1,1,-1,2},
    {1,-1,1,-1,1,-1,1,1,-1,1,2},
    {1,1,-1,-1,-1,1,1,1,1,-1,2},
    {-1,1,-1,1,1,-1,1,1,-1,1,2},
    {1,-1,-1,1,1,1,-1,-1,1,1,2},
    {-1,1,1,-1,1,1,-1,-1,1,1,2},
    {-1,1,1,1,1,1,1,-1,-1,-1,2},
    {1,1,-1,1,-1,1,-1,1,-1,1,2},
    {1,-1,1,1,1,-1,-1,1,1,-1,2},
    {1,1,1,-1,-1,-1,1,-1,1,1,2},
    {-1,-1,1,1,1,-1,1,1,-1,-1,2},
    {1,1,-1,-1,-1,-1,1,1,-1,1,2},
    {1,-1,1,-1,1,-1,-1,-1,1,1,2},
    {1,-1,1,-1,-1,-1,1,1,1,-1,2},
    {-1,-1,1,1,1,1,-1,-1,1,-1,2},
    {-1,1,1,-1,-1,1,1,-1,1,-1,2},
    {1,1,-1,-1,-1,1,-1,-1,1,1,2},
    {1,-1,-1,1,-1,1,-1,1,1,-1,2},
    {1,-1,-1,1,1,-1,-1,1,-1,1,2},
    {-1,1,-1,1,1,1,-1,-1,-1,1,2},
    {-1,1,1,-1,1,-1,1,-1,-1,1,2},
    {-1,1,-1,1,-1,1,1,1,-1,-1,2},
    {1,-1,-1,-1,1,1,1,-1,-1,-1,1},
    {1,1,1,1,-1,-1,-1,-1,-1,-1,1},
    {-1,1,-1,-1,1,-1,-1,1,1,-1,1},
    {-1,-1,1,-1,-1,1,-1,1,-1,1,1},
    {-1,-1,-1,1,-1,-1,1,-1,1,1,1},
    {2,2,2,2,-1,-1,-1,-1,-1,-1,3},
    {2,-1,-1,-1,2,2,2,-1,-1,-1,3},
    {-1,2,-1,-1,2,-1,-1,2,2,-1,3},
    {-1,-1,2,-1,-1,2,-1,2,-1,2,3},
    {-1,-1,-1,2,-1,-1,2,-1,2,2,3},
    {0,-2,2,-2,-2,1,1,2,0,1,3},
    {0,2,-2,-2,1,-2,1,2,1,0,3},
    {2,0,-2,-2,1,1,2,1,-2,0,3},
    {2,-2,0,-2,1,1,2,1,0,-2,3},
    {-2,2,-2,0,1,0,1,2,1,-2,3},
    {2,1,2,1,-2,-2,0,0,1,-2,3},
    {-2,-2,2,0,0,1,1,2,-2,1,3},
    {1,0,1,-2,-2,1,0,2,-2,2,3},
    {2,2,1,1,-2,-2,0,0,-2,1,3},
    {1,0,-2,1,-2,0,1,-2,2,2,3},
    {2,-2,-2,0,2,1,1,0,-2,1,3},
    {1,0,1,-2,2,1,2,-2,-2,0,3},
    {-2,1,1,0,0,2,-2,1,-2,2,3},
    {-2,0,1,1,-2,0,2,-2,2,1,3},
    {2,-2,-2,0,1,2,1,0,1,-2,3},
    {-2,-2,0,2,0,1,1,-2,2,1,3},
    {-2,0,1,1,-2,2,0,2,-2,1,3},
    {-2,2,0,-2,1,1,0,1,2,-2,3},
    {1,1,2,2,1,0,-2,-2,0,-2,3},
    {-2,1,1,0,2,0,-2,1,2,-2,3},
    {2,1,1,2,0,-2,-2,1,-2,0,3},
    {1,0,-2,1,2,2,1,-2,-2,0,3},
    {1,-2,1,0,2,1,2,0,-2,-2,3},
    {1,2,1,2,-2,1,0,0,-2,-2,3},
    {1,2,2,1,-2,0,1,-2,0,-2,3},
    {1,1,-2,0,1,2,2,0,-2,-2,3},
    {-2,0,-2,2,1,0,1,-2,1,2,3},
    {2,-2,0,-2,2,1,1,-2,0,1,3},
    {2,0,-2,-2,1,2,1,-2,1,0,3},
    {1,1,-2,0,1,0,-2,2,2,-2,3},
    {2,2,1,1,-2,0,-2,-2,0,1,3},
    {1,-2,0,1,2,2,1,-2,0,-2,3},
    {1,-2,1,0,0,1,-2,2,-2,2,3},
    {-2,0,2,-2,1,1,0,1,-2,2,3},
    {1,2,2,1,0,-2,1,-2,-2,0,3},
    {2,1,1,2,-2,0,-2,1,0,-2,3},
    {1,2,1,2,0,1,-2,-2,-2,0,3},
    {2,1,2,1,0,-2,-2,-2,1,0,3},
    {-2,1,0,1,2,-2,0,2,1,-2,3},
    {1,1,0,-2,1,-2,0,2,2,-2,3},
    {1,1,0,-2,1,2,2,-2,0,-2,3},
    {-2,1,0,1,0,-2,2,-2,1,2,3},
    {1,-2,0,1,0,-2,1,-2,2,2,3},
    {1,1,2,2,1,-2,0,0,-2,-2,3},
    {0,1,-2,1,-2,-2,2,0,1,2,3},
    {0,1,1,-2,-2,2,-2,1,0,2,3},
    {0,2,-2,-2,1,1,-2,1,2,0,3},
    {0,-2,-2,2,-2,1,1,0,2,1,3},
    {-2,-2,2,0,0,2,-2,1,1,1,3},
    {-2,2,0,-2,2,-2,0,1,1,1,3},
    {-2,2,-2,0,2,0,-2,1,1,1,3},
    {-2,0,2,-2,-2,2,0,1,1,1,3},
    {-2,0,-2,2,-2,0,2,1,1,1,3},
    {-2,-2,0,2,0,-2,2,1,1,1,3},
    {0,-2,2,-2,1,1,-2,1,0,2,3},
    {0,-2,1,1,-2,2,-2,2,0,1,3},
    {0,1,-2,1,2,-2,-2,2,1,0,3},
    {0,-2,1,1,-2,-2,2,0,2,1,3},
    {0,1,1,-2,2,-2,-2,1,2,0,3},
    {0,-2,-2,2,1,-2,1,0,1,2,3},
    {0,-2,-2,2,1,1,-2,-1,2,2,3},
    {-2,0,-2,2,1,-1,2,1,-2,2,3},
    {-2,-1,1,2,-2,0,2,1,2,-2,3},
    {-1,-2,2,1,-2,2,1,2,0,-2,3},
    {2,0,-2,-2,-2,2,2,1,1,-1,3},
    {-2,-2,2,0,-1,2,1,2,1,-2,3},
    {1,2,-2,-1,-2,0,1,2,2,-2,3},
    {2,1,-1,-2,-2,2,2,1,0,-2,3},
    {-2,-2,0,2,-1,1,2,1,2,-2,3},
    {-2,2,-2,0,2,-1,1,2,-2,1,3},
    {2,-2,0,-2,2,-2,2,1,-1,1,3},
    {1,-1,-2,2,1,0,-2,-2,2,2,3},
    {2,-1,-2,1,2,2,-2,-2,1,0,3},
    {-2,0,2,-2,1,2,-1,-2,1,2,3},
    {2,-1,1,-2,2,-2,2,1,-2,0,3},
    {1,-1,2,-2,1,-2,0,2,-2,2,3},
    {1,-2,-1,2,0,1,-2,-2,2,2,3},
    {2,-2,1,-1,2,-2,2,0,-2,1,3},
    {1,0,-2,1,-2,2,-1,2,-2,2,3},
    {1,-2,2,-1,0,-2,1,2,-2,2,3},
    {-2,-1,2,1,-2,2,0,2,1,-2,3},
    {-1,-2,1,2,-2,1,2,0,2,-2,3},
    {2,-2,2,2,0,-2,-2,1,1,-1,3},
    {2,-2,-2,0,2,2,-2,-1,1,1,3},
    {-2,2,0,-2,2,1,-1,-2,2,1,3},
    {2,2,-2,2,-2,1,-1,0,-2,1,3},
    {-1,2,1,-2,2,1,-2,-2,2,0,3},
    {-2,1,2,-1,0,2,-2,-2,1,2,3},
    {1,2,-1,-2,-2,1,0,2,2,-2,3},
    {2,1,-2,-1,-2,2,2,0,1,-2,3},
    {-2,2,2,2,1,0,1,-2,-1,-2,3},
    {-2,2,2,2,0,1,1,-2,-2,-1,3},
    {-2,0,1,1,2,2,2,-2,-2,-1,3},
    {1,-2,0,1,2,-2,-1,2,2,-2,3},
    {1,0,1,-2,-2,-1,2,-2,2,2,3},
    {2,2,2,-2,-1,-2,1,-2,1,0,3},
    {-2,2,-1,1,2,-2,0,2,-2,1,3},
    {2,-2,-1,1,2,2,-2,-2,0,1,3},
    {-1,2,-2,1,2,-2,1,2,-2,0,3},
    {-1,1,2,-2,1,2,-2,-2,0,2,3},
    {-2,2,1,-1,2,0,-2,-2,2,1,3},
    {-2,2,2,2,1,1,0,-1,-2,-2,3},
    {-2,1,1,0,2,2,2,-1,-2,-2,3},
    {-2,1,-1,2,0,-2,2,1,-2,2,3},
    {2,2,-2,2,-2,0,-2,1,-1,1,3},
    {2,2,2,-2,-2,-2,0,-1,1,1,3},
    {1,1,0,-2,-1,-2,2,-2,2,2,3},
    {2,-2,2,2,1,-1,-2,1,0,-2,3},
    {1,-2,1,0,2,-1,-2,2,2,-2,3},
    {2,2,-2,2,-1,1,-2,1,-2,0,3},
    {2,2,2,-2,-2,-1,1,-2,0,1,3},
    {-2,1,0,1,2,2,2,-2,-1,-2,3},
    {-1,1,-2,2,1,-2,2,0,-2,2,3},
    {2,-2,2,2,1,-2,-1,0,1,-2,3},
    {1,1,-2,0,-1,2,-2,2,-2,2,3},
    {0,1,1,-2,-2,-2,2,-1,2,2,3},
    {0,2,-2,-2,-2,1,1,2,2,-1,3},
    {0,-2,2,-2,1,-2,1,2,-1,2,3},
    {0,-2,1,1,2,-2,-2,2,2,-1,3},
    {0,1,-2,1,-2,2,-2,2,-1,2,3},
    {-2,2,-4,2,2,-4,2,3,-1,3,5},
    {2,2,-4,-2,-1,3,2,3,2,-4,5},
    {-4,2,-2,2,3,-4,3,2,-1,2,5},
    {2,-4,2,-2,3,-1,2,3,-4,2,5},
    {-1,2,2,3,2,2,3,-2,-4,-4,5},
    {2,-1,2,3,2,-2,-4,2,3,-4,5},
    {-1,2,3,2,2,3,2,-4,-2,-4,5},
    {3,2,-1,2,-4,3,-4,2,-2,2,5},
    {2,-4,-2,2,3,2,-1,-4,3,2,5},
    {-4,2,2,-2,3,3,-4,-1,2,2,5},
    {-1,3,2,2,3,2,2,-4,-4,-2,5},
    {2,-2,-4,2,2,3,-1,-4,2,3,5},
    {2,-2,2,-4,2,-1,3,2,-4,3,5},
    {2,-1,3,2,2,-4,-2,3,2,-4,5},
    {2,2,-2,-4,-1,2,3,2,3,-4,5},
    {-4,3,3,-4,2,2,-2,-1,2,2,5},
    {3,-4,-4,3,2,2,-1,-2,2,2,5},
    {3,3,-4,-4,-1,2,2,2,2,-2,5},
    {3,2,2,-1,-4,-4,3,-2,2,2,5},
    {3,-4,3,-4,2,-1,2,2,-2,2,5},
    {-4,3,-4,3,2,-2,2,2,-1,2,5},
    {2,3,-1,2,-4,2,-2,3,-4,2,5},
    {2,3,2,-1,-4,-2,2,-4,3,2,5},
    {2,2,-1,3,-2,2,-4,2,-4,3,5},
    {3,-1,2,2,3,-4,-4,2,2,-2,5},
    {-4,-4,3,3,-2,2,2,2,2,-1,5},
    {-4,-2,2,2,-4,3,3,2,2,-1,5},
    {2,2,3,-1,-2,-4,2,-4,2,3,5},
    {-2,2,2,-4,2,2,-4,-1,3,3,5},
    {-2,-4,2,2,-4,2,2,3,3,-1,5}
};



/**
 * Class for separating all facets of small clique partitioning polytopes (n = 4, 5).
 */
template<class EDGE_VALUE_MAP>
class CompleteSeparator : public AbstractSeparator<int, EDGE_VALUE_MAP> 
{
public:
    CompleteSeparator(size_t n, size_t max_num, size_t k) : 
        AbstractSeparator<int, EDGE_VALUE_MAP>(n, max_num),
        k_(k),
        coefficients_()
    {
        if (k == 4)
            coefficients_ = coefficients_4;
        else if (k = 5)
            coefficients_ = coefficients_5;
        else
            throw std::runtime_error("Facts of CP_" + std::to_string(k) + " are not known");
        assert (coefficients_.back().size() == k * (k-1) / 2 + 1);
    }
    
    std::string name() { return "Complete"+std::to_string(k_); }

    std::vector<Inequality<int>> separate_(const EDGE_VALUE_MAP& edge_values)
    {
        std::vector<Inequality<int>> inequalities;

        std::vector<size_t> choice(k_);
        // iterate over all choices of k nodes
        iterate_(choice, 0, inequalities, edge_values);

        this->sort_and_reduce_by_violation_depth(inequalities);
        this->reduce_by_parallelism(inequalities);

        return inequalities;
    }


private:

    size_t k_;

    std::vector<std::vector<int>> coefficients_;

    // recursively iterate over all choices of k nodes
    void iterate_(std::vector<size_t>& choice, size_t i, std::vector<Inequality<int>>& inequalities, const EDGE_VALUE_MAP& edge_values)
    {
        size_t start = 0;
        if (i > 0)
            start = choice[i-1] + 1;
        for (choice[i] = start; choice[i] < this->n_; ++choice[i])
        {       
            bool one_exists = false;
            for (size_t j = 0; j < i; ++j)
            { 
                if (edge_values(choice[i], choice[j]) >= 1 - this->min_violation_)
                {
                    one_exists = true;
                    break; 
                }
            }
            if (one_exists)
                continue;
            if (i == 1 && edge_values(choice[0], choice[1]) < this->min_violation_)
                continue; // there must be at least one fractional variable

            if (i == this->k_ - 1)
                separate_choice_(choice, inequalities, edge_values);
            else 
                iterate_(choice, i+1, inequalities, edge_values);
        }
    }

    // iterate over all inequalities and test if they are violated with respect to the k chosen nodes
    void separate_choice_(std::vector<size_t>& choice, std::vector<Inequality<int>>& inequalities, const EDGE_VALUE_MAP& edge_values)
    {
        for (const std::vector<int>& coeff : coefficients_)
        {
            int rhs = coeff.back();
            double lhs = 0;
            for (size_t i = 0; i < k_; ++i)
            for (size_t j = i+1; j < k_; ++j)
            {
                size_t idx = k_ * (k_ - 1) / 2 - (k_ - i)*(k_ - i - 1) / 2 + j - i - 1;
                lhs += edge_values(choice[i], choice[j]) * coeff[idx];
            }
            double violation = lhs - rhs;
            if (violation <= this->min_violation_)
                continue;

            std::vector<std::array<size_t, 2>> edges;
            std::vector<int> edge_coeff;
            for (size_t i = 0; i < k_; ++i)
            for (size_t j = i+1; j < k_; ++j)
            {
                size_t idx = k_ * (k_ - 1) / 2 - (k_ - i)*(k_ - i - 1) / 2 + j - i - 1;
                int c = coeff[idx];
                if (c == 0)
                    continue;
                lhs += edge_values(choice[i], choice[j]) * c;
                edges.push_back({choice[i], choice[j]});
                edge_coeff.push_back(c);
            }
            inequalities.push_back({edges, edge_coeff, rhs, violation});
        }
    }

};


} // namespace CP
